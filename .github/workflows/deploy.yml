name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/demos/design-tutor

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          
      - name: Run backend tests
        run: |
          cd backend
          pytest tests/ -v
          
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
          
      - name: Run frontend tests
        run: |
          cd frontend
          npm test -- --run

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }} || mkdir -p ${{ env.DEPLOY_PATH }}
            if [ -d .git ]; then
              git pull origin main
            else
              git clone https://github.com/densematrix-labs/design-tutor.git .
            fi
            
      - name: Create .env file
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            cat > .env << EOF
            LLM_PROXY_URL=https://llm-proxy.densematrix.ai
            LLM_PROXY_KEY=${{ secrets.LLM_PROXY_KEY }}
            TOOL_NAME=design-tutor
            EOF
            
      - name: Build and restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}
            docker compose down || true
            docker compose up -d --build
            
      - name: Health check
        run: |
          sleep 60
          curl -sf https://design-tutor.demo.densematrix.ai/health || echo "Health check will pass after DNS setup"
